# Story 5.2: Data Export Functionality

## Status

Ready for Review

## Story

**As a** Pro user with valuable grow data,
**I want** to export my plant and diary data to standard formats,
**so that** I can backup my data, analyze it externally, or migrate to other tools if needed.

## Acceptance Criteria

1. Pro users can export data from Settings > Data Export section
2. Users can choose export scope: single plant, all plants, or specific date range
3. Users can choose export format: CSV or JSON
4. CSV export includes:
   - Plants table: plant details, creation dates, current status
   - Events table: event type, timestamp, plant name, notes, values
   - Flattened structure suitable for spreadsheet analysis
5. JSON export includes:
   - Complete plant objects with nested events
   - Structured format preserving data relationships
   - Includes metadata (export date, app version, user's timezone)
6. Export respects user privacy: no identifiable information included by default
7. Export process shows progress indicator for large datasets
8. Completed export triggers iOS Share Sheet for user to save/send
9. Free users see export feature with Pro upgrade prompt
10. Export includes README file explaining data structure and column meanings

## Tasks / Subtasks

- [x] Implement export data layer (AC: 2-6)
  - [x] Create `DataExportService` under `Domain/Services/`
  - [x] Implement plant and event queries with scope filtering
  - [x] Build CSV serializer with proper escaping and encoding
  - [x] Build JSON serializer with structured format
  - [x] Strip potentially sensitive data (location, identifiers)
- [x] Build export UI (AC: 1, 7, 8, 9)
  - [x] Create `DataExportView` under `Features/Settings/`
  - [x] Add scope selector (single plant / all plants / date range)
  - [x] Add format selector (CSV / JSON)
  - [x] Implement progress indicator for export generation
  - [x] Trigger Share Sheet with generated files
  - [x] Add Pro gating with upgrade prompt for Free users
- [x] Generate README file (AC: 10)
  - [x] Create README template explaining CSV columns
  - [x] Include JSON schema documentation
  - [x] Add timestamp and version to README
  - [x] Include README.txt in export bundle

## Dev Notes

### Architecture Context

- Use FileManager and TemporaryDirectory for file generation
- Leverage Swift's Codable for JSON serialization
- Use CSVWriter pattern for CSV generation (or lightweight library)
- All export processing should be async/await to avoid blocking UI

### Source Tree

```
GroBroPackage/
  Sources/GroBroFeature/
    Domain/
      Services/
        DataExportService.swift          # Export logic and serialization
    Features/
      Settings/
        DataExportView.swift             # Export UI
```

### Key Implementation Notes

1. **CSV Structure:**
   ```
   plants.csv:
   plant_id, name, strain, created_date, stage, substrate_type, pot_size_liters, status

   events.csv:
   event_id, plant_name, event_type, timestamp, notes, water_volume_ml, stress_tag, photo_filename
   ```

2. **JSON Structure:**
   ```json
   {
     "export_metadata": {
       "export_date": "2025-11-14T10:30:00Z",
       "app_version": "1.0.0",
       "timezone": "America/Los_Angeles"
     },
     "plants": [
       {
         "id": "uuid",
         "name": "Plant A",
         "events": [...]
       }
     ]
   }
   ```

3. **Privacy Considerations:**
   - Do NOT include: GPS coordinates, device IDs, user account info
   - DO include: plant names, diary notes (user-entered, user controls content)
   - Add option to anonymize plant names ("Plant 1", "Plant 2") if user wants

4. **Performance:**
   - For large datasets (1000+ events), process in batches
   - Show determinate progress bar (X of Y events processed)
   - Generate files in background task, don't block main thread

5. **File Packaging:**
   - Create temporary directory for export
   - Generate files: plants.csv/events.csv (or data.json) + README.txt
   - ZIP bundle if multiple files
   - Use Share Sheet to let user choose destination (Files app, AirDrop, email)

### Testing

- Unit tests:
  - DataExportService correctly serializes plants and events to CSV format
  - DataExportService correctly serializes to JSON format
  - Scope filtering (single plant, date range) produces correct subset
  - CSV escaping handles quotes, commas, newlines in notes
  - Privacy filter strips sensitive data
- Integration tests:
  - Full export flow with sample data (10 plants, 500 events)
  - Progress indicator updates correctly
  - Share Sheet presents with valid file
- Manual checks:
  - CSV opens correctly in Numbers/Excel
  - JSON is valid and parseable
  - README is clear and helpful
  - Export completes in reasonable time (< 10s for 1000 events)

## Change Log

| Date       | Version | Description                            | Author |
|-----------|---------|----------------------------------------|--------|
| 2025-11-14 | 0.1     | Initial story draft and approval       | PO/PM  |
| 2025-11-14 | 1.0     | Implementation complete - Ready for Review | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

OpenAI GPT-5.1 (gpt-5.1-codex-cli)

### Debug Log References

None

### Completion Notes List

- Implemented `DataExportService` with CSV and JSON serializers, date range filtering, anonymization support, and ZIP packaging using `FileManager` and temporary directories.
- Added `DataExportView` under `Features/Settings/` with scope selector (single plant, all plants, date range), format selector (CSV/JSON), anonymization toggle, and progress indicator bound to background export work.
- Wired Data Export into `SubscriptionSettingsView` as a "Data & Export" section so Pro users can access exports from Settings, with in-view Pro gating and upgrade prompts for Free users.
- Used Swift's Codable for JSON export matching the specified `export_metadata` and nested plant/event structure, and implemented robust CSV escaping for spreadsheet-friendly output.
- Created `DataExportServiceTests` covering JSON structure, CSV headers, and anonymization behavior for deterministic exports.

### File List

- GroBroPackage/Sources/GroBroDomain/Services/DataExportService.swift
- GroBroPackage/Sources/GroBroFeature/Settings/DataExportView.swift
- GroBroPackage/Sources/GroBroFeature/Subscription/SubscriptionSettingsView.swift
- GroBroPackage/Tests/GroBroDomainTests/DataExportServiceTests.swift
