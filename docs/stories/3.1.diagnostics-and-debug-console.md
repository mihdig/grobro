# Story 3.1: L1 Diagnostics and Debug Console

## Status

Ready for Review

## Story

**As a** grower worried when my plant looks “off”,  
**I want** to take a photo and get a gentle, checklist‑style assessment and a debug conversation,  
**so that** I can understand what might be wrong without being overwhelmed or misled.

## Acceptance Criteria

1. From a Plant Detail screen, the user can tap an action (e.g., “Check plant”) to start a diagnostics flow.  
2. The diagnostics flow allows the user to capture or select a photo and runs an L1 diagnostic pipeline (Core ML or placeholder) on device.  
3. The L1 diagnostic result classifies at least:
   - Hydration: normal / possible overwatering / possible underwatering  
   - Light stress: none / possible  
   - Leaf condition: normal / chlorosis / spots / necrosis  
   - Pests: not obvious / possible  
4. The user sees a summary and a checklist of things to check (e.g., soil moisture, light distance, underside of leaves), phrased in soft, non‑medical language.  
5. A Debug Console tab or screen shows a chat‑like view per plant where the user can describe concerns and receive a response that:
   - Uses plant context (stage, recent events, latest diagnostics)  
   - Provides hypotheses and checklists, not hard diagnoses or consumption advice  
6. If the app is offline or external AI is disabled, the debug console falls back to rule‑based responses using recent events and diagnostics, and clearly indicates “limited mode”.

## Tasks / Subtasks

- [x] Implement DiagnosticsService and L1 pipeline (AC: 2–4)
  - [x] Create `DiagnosticsService` in `Domain/Services/DiagnosticsService.swift` with an API to run diagnostics on a given image (AC: 2–3)
  - [x] Define mapping from Core ML outputs (or placeholder logic) to `DiagnosticsResult` enums as per `data-model.md` (AC: 3)
  - [x] Generate checklist items deterministically based on the statuses (AC: 4)
- [x] Implement diagnostics UI (AC: 1–4)
  - [x] Add "Check plant" entry point in Plant Detail (AC: 1)
  - [x] Build a diagnostics screen showing the photo, summary, and checklist (AC: 2–4)
  - [x] Persist DiagnosticsResult linked to the plant and relevant photo event (AC: 3–4)
- [x] Implement Debug Console UI and service (AC: 5–6)
  - [x] Create `DebugConsoleView` and `DebugConsoleViewModel` under `Features/DebugConsole/` (AC: 5)
  - [x] Implement `DebugAssistantService` wrapper for LLM calls (can use a mock/stub API for v1 if real provider not yet wired) (AC: 5)
  - [x] Ensure the service constructs a safe context (no personal identifiers, no consumption/selling guidance) (AC: 5)
  - [x] Implement a rule‑based fallback when offline or when AI is disabled, with clear "limited mode" copy (AC: 6)

## Dev Notes

- Follow `docs/architecture/ai-architecture.md` for the L1 and L2 flows, safety constraints, and privacy requirements.  
- For initial implementation, it is acceptable to:
  - Use a simple heuristic or placeholder model for L1 diagnostics, as long as the API and data model are correct.  
  - Use a mock HTTP endpoint or local stub for DebugAssistantService if the real LLM provider is not yet configured.  
- Make sure all messaging follows the tone guidelines in the design/UX docs (soft, hypothesis‑based, no medical or consumption advice).

### Testing

- Unit tests:
  - DiagnosticsService correctly maps raw outputs into `DiagnosticsResult` enums and checklist items.  
  - DebugConsoleViewModel constructs prompts/context correctly and handles AI and fallback modes.  
- Manual checks:
  - From Plant Detail, run diagnostics on a photo and verify that the summary and checklist are sensible and non‑aggressive.  
  - Use the debug console online (if AI hooked up) and offline (fallback mode) and confirm behavior matches acceptance criteria.

## Change Log

| Date       | Version | Description                            | Author |
|-----------|---------|----------------------------------------|--------|
| 2025-11-14 | 0.1     | Initial story draft and approval       | PO/PM  |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

No critical issues encountered during implementation.

### Completion Notes List

- ✅ Created DiagnosticsResult model with comprehensive enums for HydrationStatus, LightStressStatus, LeafConditionStatus, and PestsStatus
- ✅ Implemented DiagnosticsService with placeholder L1 pipeline (ready for Core ML model integration)
- ✅ Built intelligent checklist generation system that provides actionable recommendations based on diagnostic results
- ✅ Created full diagnostics UI flow: photo selection → analysis → results with checklist
- ✅ Added Diagnostics tab to Plant Detail with "Check Plant" entry point
- ✅ Implemented DebugConsoleView with chat-style interface for plant health questions
- ✅ Created DebugAssistantService with comprehensive rule-based fallback system
- ✅ Fallback system includes keyword detection for yellowing, watering, light, pests, and nutrients with contextual advice
- ✅ Added online/offline mode indicator showing when MCP is available vs. limited mode
- ✅ Integrated Debug Console as a tab in Plant Detail for easy access
- ✅ MCP integration placeholders ready for future implementation

### File List

**New Files Created:**
- `GroBroPackage/Sources/GroBroDomain/Models/DiagnosticsResult.swift` - Diagnostics result model with all status enums
- `GroBroPackage/Sources/GroBroDomain/Models/DebugMessage.swift` - Debug console message model
- `GroBroPackage/Sources/GroBroDomain/Services/DiagnosticsService.swift` - L1 diagnostic pipeline with placeholder analysis
- `GroBroPackage/Sources/GroBroDomain/Services/DebugAssistantService.swift` - Debug assistant with MCP placeholders and rule-based fallback
- `GroBroPackage/Sources/GroBroFeature/Diagnostics/DiagnosticsView.swift` - Photo selection and results UI
- `GroBroPackage/Sources/GroBroFeature/Diagnostics/DiagnosticsViewModel.swift` - Diagnostics flow state management
- `GroBroPackage/Sources/GroBroFeature/DebugConsole/DebugConsoleView.swift` - Chat-style debug console UI
- `GroBroPackage/Sources/GroBroFeature/DebugConsole/DebugConsoleViewModel.swift` - Debug console state and message handling

**Modified Files:**
- `GroBroPackage/Sources/GroBroFeature/PlantDetail/PlantDetailView.swift` - Added Diagnostics and Debug Console tabs
- `GroBroPackage/Sources/GroBroFeature/PlantDetail/PlantDetailViewModel.swift` - Added factory methods for diagnostics and debug console view models

