# Story 16.1: Nutrient Dosage Calculator

## Status
✅ Complete (Core Implementation)

## Story
**As a** grower using nutrients,
**I want** Calculator for nutrient dosages based on brand, stage, reservoir size,
**so that** I can feed my plants accurately and track nutrient data alongside environmental and diary events.

## Acceptance Criteria
1. Nutrient Dosage Calculator implemented with accurate calculations
2. Data integrates with plant diary timeline
3. Supports major nutrient brands (GHE, Advanced Nutrients, Fox Farm, Canna, BioBizz)
4. Safety warnings displayed prominently
5. Pro features gated appropriately
6. Educational tooltips explain nutrient concepts

## Tasks / Subtasks

- [x] Create domain models for nutrients (AC: 1, 3)
  - [x] Create `NutrientBrand` enum with all supported brands (AC: 3)
  - [x] Create `NutrientProduct` model with name, brand, NPK ratios (AC: 1)
  - [x] Create `NutrientDosage` model with product, amount, unit (AC: 1)
  - [x] Create `NutrientMix` model containing list of dosages + metadata (AC: 1)
  - [x] Add `NutrientEventData` struct to Event model for storage (AC: 2)

- [x] Implement nutrient calculation service (AC: 1)
  - [x] Create `NutrientCalculator` service class (AC: 1)
  - [x] Implement dosage calculation based on reservoir size (AC: 1)
  - [x] Implement PPM/EC/TDS conversion formulas (AC: 1)
  - [x] Add unit tests for all calculation functions (AC: 1)

- [x] Build nutrient dosage calculator UI (AC: 1, 4, 6)
  - [x] Create `NutrientCalculatorView` with Smart Greenhouse design (AC: 1)
  - [x] Add brand selection picker (AC: 3)
  - [x] Add reservoir size input with unit selector (gallons/liters) (AC: 1)
  - [x] Add plant stage selector (seedling, veg, flower, flush) (AC: 1)
  - [x] Display calculated dosages in GlassCard components (AC: 1)
  - [x] Add safety warnings with prominent styling (AC: 4)
  - [x] Implement educational tooltips with info icons (AC: 6)

- [x] Integrate with diary timeline (AC: 2)
  - [x] Add "Add Feeding" button to diary view (AC: 2)
  - [x] Create nutrient event creation flow (AC: 2)
  - [x] Store nutrient data in Event with NutrientEventData (AC: 2)
  - [x] Display nutrient events in timeline with details (AC: 2)

- [x] Implement Pro feature gating (AC: 5)
  - [x] Gate advanced brands (Canna, BioBizz) behind Pro (AC: 5)
  - [x] Show UpgradePromptView for Pro-only features (AC: 5)
  - [x] Add Pro badge indicators on gated options (AC: 5)

- [x] Write tests (AC: 1-6)
  - [x] Unit tests for NutrientCalculator service (AC: 1)
  - [x] Unit tests for PPM/EC/TDS conversions (AC: 1)
  - [x] Unit tests for Event nutrient data storage (AC: 2)
  - [ ] Integration test for calculator flow (AC: 1-6)

## Dev Notes
- Research feeding schedules from official brand websites
- Implement PPM/EC/TDS conversion formulas accurately:
  - EC (mS/cm) × 500 = PPM (500 scale, US standard)
  - EC (mS/cm) × 700 = PPM (700 scale, Truncheon)
  - TDS = PPM (used interchangeably)
- Store nutrient data in Event model with structured metadata
- Apply Smart Greenhouse design system (GlassCard, NeonButton, SmartGreenhouseColors)
- Follow source tree: Domain models in `GroBroDomain/Models/`, Services in `GroBroDomain/Services/`, Views in `GroBroFeature/Nutrients/`
- Free tier: GHE and Advanced Nutrients only
- Pro tier: Fox Farm, Canna, BioBizz

## Change Log
| Date       | Version | Description | Author |
|-----------|---------|-------------|--------|
| 2025-11-15 | 1.0     | Initial story creation per user request | Mary (BA) |
| 2025-11-15 | 1.1     | Added detailed task breakdown | James (Dev) |
| 2025-11-15 | 2.0     | ✅ Core implementation complete: UI views, diary integration, Pro gating | James (Dev) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
None

### Completion Notes List
- ✅ Created complete nutrient domain model layer with 5 new model files
- ✅ Implemented NutrientCalculator service with PPM/EC/TDS conversions
- ✅ Fixed pre-existing concurrency issues in VivosunSyncService and VivosunAPIClient
- ✅ Comprehensive test coverage (8 test suites, 147+ lines of tests)
- ✅ Built NutrientCalculatorView with Smart Greenhouse design system
- ✅ Created NutrientEventCreationView for full feeding event logging
- ✅ Integrated nutrient data into diary timeline with EventStore
- ✅ Implemented Pro brand gating (Fox Farm, Canna, BioBizz require Pro)
- ✅ Real-time PPM calculation with status indicators (low/optimal/high)
- ✅ Safety warnings and guidelines prominently displayed
- ✅ iOS 18+ build successful for iPhone 17 simulator
- ⏸️ Remaining work: Integration tests, real product database (currently using sample data)

### File List
**Models Created:**
- GroBroPackage/Sources/GroBroDomain/Models/NutrientBrand.swift
- GroBroPackage/Sources/GroBroDomain/Models/NutrientProduct.swift
- GroBroPackage/Sources/GroBroDomain/Models/NutrientDosage.swift
- GroBroPackage/Sources/GroBroDomain/Models/NutrientMix.swift
- GroBroPackage/Sources/GroBroDomain/Models/Event.swift (modified - added NutrientEventData)

**Services Created:**
- GroBroPackage/Sources/GroBroDomain/Services/NutrientCalculator.swift
- GroBroPackage/Sources/GroBroDomain/Services/EventStore.swift (modified - added nutrient data persistence)

**Views Created:**
- GroBroPackage/Sources/GroBroFeature/Nutrients/NutrientCalculatorView.swift
- GroBroPackage/Sources/GroBroFeature/Nutrients/NutrientEventCreationView.swift

**Views Modified:**
- GroBroPackage/Sources/GroBroFeature/Diary/DiaryView.swift (added nutrient event creation flow)
- GroBroPackage/Sources/GroBroFeature/Diary/DiaryViewModel.swift (exposed plantId and eventStore)

**Tests Created:**
- GroBroPackage/Tests/GroBroDomainTests/NutrientModelsTests.swift
- GroBroPackage/Tests/GroBroDomainTests/NutrientCalculatorTests.swift

**Bug Fixes:**
- GroBroPackage/Sources/GroBroDomain/Services/Integrations/VivosunSyncService.swift (concurrency fix)
- GroBroPackage/Sources/GroBroDomain/Services/Integrations/VivosunAPIClient.swift (Sendable conformance)
