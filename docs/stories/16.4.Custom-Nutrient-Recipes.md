# Story 16.4: Custom Nutrient Recipes

## Status
Approved

## Story
**As a** grower using nutrients,
**I want** User-defined nutrient mixes with save/reuse functionality,
**so that** I can feed my plants accurately and track nutrient data alongside environmental and diary events.

## Acceptance Criteria
1. Custom Nutrient Recipes implemented with accurate calculations
2. Data integrates with plant diary timeline
3. Supports major nutrient brands (GHE, Advanced Nutrients, Fox Farm, Canna, BioBizz)
4. Safety warnings displayed prominently
5. Pro features gated appropriately
6. Educational tooltips explain nutrient concepts

## Tasks / Subtasks

- [ ] Create custom recipe domain models (AC: 1)
  - [ ] Create `CustomNutrientRecipe` model with name, products, dosages (AC: 1)
  - [ ] Add id, createdDate, lastUsedDate, usageCount fields (AC: 1)
  - [ ] Add Codable conformance for persistence (AC: 1)
  - [ ] Create `RecipeStore` service for CRUD operations (AC: 1)

- [ ] Implement recipe persistence (AC: 1, 2)
  - [ ] Add CustomRecipeEntity to Core Data model (AC: 1)
  - [ ] Implement save/load/delete recipe operations (AC: 1)
  - [ ] Add recipe to Event as metadata option (AC: 2)
  - [ ] Support loading recipe from past feeding events (AC: 2)

- [ ] Build custom recipe creator UI (AC: 1, 3, 4, 6)
  - [ ] Create `CustomRecipeEditorView` (AC: 1)
  - [ ] Add recipe name text field (AC: 1)
  - [ ] Add product picker from all available brands (AC: 3)
  - [ ] Add dosage amount input per product (AC: 1)
  - [ ] Calculate total PPM/EC for the mix (AC: 1)
  - [ ] Display safety warnings for incompatible products (AC: 4)
  - [ ] Add tooltips explaining mixing best practices (AC: 6)
  - [ ] Save button with validation (AC: 1)

- [ ] Build recipe library UI (AC: 1)
  - [ ] Create `RecipeLibraryView` listing saved recipes (AC: 1)
  - [ ] Display recipe name, product count, last used date (AC: 1)
  - [ ] Add search/filter for recipes (AC: 1)
  - [ ] Implement swipe-to-delete (AC: 1)
  - [ ] Add edit recipe flow (AC: 1)
  - [ ] Show "Use Recipe" button to apply to calculator (AC: 1)

- [ ] Integrate recipes with calculator and diary (AC: 1, 2)
  - [ ] Allow selecting saved recipe in calculator (AC: 1)
  - [ ] Auto-fill calculator from recipe (AC: 1)
  - [ ] Scale recipe dosages by reservoir size (AC: 1)
  - [ ] Save feeding event with recipe reference (AC: 2)
  - [ ] Display recipe name in timeline events (AC: 2)
  - [ ] Quick "Use Again" from past feeding events (AC: 2)

- [ ] Apply Smart Greenhouse design (AC: 1)
  - [ ] Use GlassCard for recipe cards (AC: 1)
  - [ ] Apply neon accents to favorite/frequently used recipes (AC: 1)
  - [ ] Consistent glassmorphic styling throughout (AC: 1)

- [ ] Write tests (AC: 1-6)
  - [ ] Unit tests for RecipeStore CRUD operations (AC: 1)
  - [ ] Unit tests for recipe dosage calculations (AC: 1)
  - [ ] Unit tests for recipe scaling (AC: 1)
  - [ ] Integration test for recipe creation and reuse flow (AC: 1, 2)

## Dev Notes
- Custom recipes allow mixing products from any brand
- Calculate total PPM by summing individual product contributions
- Warn users about incompatible products (e.g., organic + synthetic can cause lockout)
- Store recipes in Core Data for offline access
- Track usage count to show "frequently used" recipes prominently
- Apply Smart Greenhouse design system
- Follow source tree: Models in `GroBroDomain/Models/`, Services in `GroBroDomain/Services/`, Views in `GroBroFeature/Nutrients/`
- Custom recipes are FREE tier (non-Pro)
- Pro users get access to all brands in their recipes (Fox Farm, Canna, BioBizz)

## Change Log
| Date       | Version | Description | Author |
|-----------|---------|-------------|--------|
| 2025-11-15 | 1.0     | Initial story creation per user request | Mary (BA) |
| 2025-11-15 | 1.1     | Added detailed task breakdown | James (Dev) |

## Dev Agent Record

### Agent Model Used
(To be filled during implementation)

### Debug Log References
(To be filled during implementation)

### Completion Notes List
(To be filled during implementation)

### File List
(To be filled during implementation)
