# Story 16.8: Nutrient Cost Tracking

## Status
Approved

## Story
**As a** grower using nutrients,
**I want** Track bottle costs and calculate cost per feeding (Pro feature),
**so that** I can feed my plants accurately and track nutrient data alongside environmental and diary events.

## Acceptance Criteria
1. Nutrient Cost Tracking implemented with accurate calculations
2. Data integrates with plant diary timeline
3. Supports major nutrient brands (GHE, Advanced Nutrients, Fox Farm, Canna, BioBizz)
4. Safety warnings displayed prominently
5. Pro features gated appropriately
6. Educational tooltips explain nutrient concepts

## Tasks / Subtasks

- [ ] Create cost tracking models (AC: 1)
  - [ ] Create `NutrientBottle` model (product, size, cost, purchaseDate) (AC: 1)
  - [ ] Add `BottleSize` enum (250ml, 500ml, 1L, 4L, etc.) (AC: 1)
  - [ ] Create `BottleInventory` model for tracking usage (AC: 1)
  - [ ] Add cost calculation utilities (AC: 1)
  - [ ] Add Codable conformance for persistence (AC: 1)

- [ ] Implement cost tracking service (AC: 1)
  - [ ] Create `NutrientCostTracker` service (AC: 1)
  - [ ] Calculate cost per ml for each bottle (AC: 1)
  - [ ] Calculate cost per feeding based on dosages (AC: 1)
  - [ ] Track total nutrient spending over time (AC: 1)
  - [ ] Add unit tests for cost calculations (AC: 1)

- [ ] Build bottle inventory manager (AC: 1, 5)
  - [ ] Create `BottleInventoryView` (Pro-gated) (AC: 1, 5)
  - [ ] Add "Add Bottle" button to create entries (AC: 1)
  - [ ] Create `BottleEditorView` form (AC: 1)
  - [ ] Product picker from all brands (AC: 3)
  - [ ] Bottle size selector (AC: 1)
  - [ ] Price input with currency (AC: 1)
  - [ ] Purchase date picker (AC: 1)
  - [ ] Display bottle list with cost/ml (AC: 1)
  - [ ] Swipe-to-delete bottles (AC: 1)

- [ ] Integrate cost tracking with feeding events (AC: 1, 2)
  - [ ] Calculate cost per feeding when logging events (AC: 1, 2)
  - [ ] Store cost data in NutrientEventData (AC: 2)
  - [ ] Display cost on feeding event cards (AC: 2)
  - [ ] Show cost breakdown by product (AC: 1)

- [ ] Build cost analytics dashboard (AC: 1, 5)
  - [ ] Create `NutrientCostAnalyticsView` (Pro-gated) (AC: 1, 5)
  - [ ] Display total spending by brand (AC: 1, 3)
  - [ ] Show average cost per feeding (AC: 1)
  - [ ] Display monthly nutrient spending trend (AC: 1)
  - [ ] Show cost per plant breakdown (AC: 1)
  - [ ] Compare cost efficiency of different brands (AC: 1)
  - [ ] Export cost data to CSV (AC: 1)

- [ ] Implement Pro feature gating (AC: 5)
  - [ ] Gate entire cost tracking feature behind Pro (AC: 5)
  - [ ] Show UpgradePromptView when accessing cost features (AC: 5)
  - [ ] Display Pro badge on cost-related UI elements (AC: 5)
  - [ ] Show preview/teaser of cost tracking for free users (AC: 5)

- [ ] Add cost insights and tips (AC: 6)
  - [ ] Show tooltip explaining cost tracking benefits (AC: 6)
  - [ ] Recommend bulk bottle sizes for savings (AC: 6)
  - [ ] Highlight most cost-effective products (AC: 1)
  - [ ] Show cost per grow cycle (AC: 1)

- [ ] Apply Smart Greenhouse design (AC: 1)
  - [ ] Use GlassCard for bottle inventory (AC: 1)
  - [ ] Apply purple neon for Pro badges (AC: 5)
  - [ ] Use charts with neon styling for cost trends (AC: 1)
  - [ ] Consistent glassmorphic styling (AC: 1)

- [ ] Write tests (AC: 1-6)
  - [ ] Unit tests for cost calculation service (AC: 1)
  - [ ] Unit tests for cost per feeding (AC: 1)
  - [ ] Unit tests for spending analytics (AC: 1)
  - [ ] Test Pro gating logic (AC: 5)
  - [ ] Integration test for cost tracking flow (AC: 1, 2, 5)

## Dev Notes
- Cost tracking is a PRO-only feature
- Calculate cost per ml: bottleCost / bottleSizeMl
- Calculate feeding cost: sum(dosageAmount * costPerMl) for all products
- Track inventory depletion based on feeding events (optional future enhancement)
- Common bottle sizes:
  - 250ml, 500ml, 1L, 4L (gallon), 10L, 23L (5 gallon)
- Store bottle inventory in Core Data
- Store cost data with feeding events in NutrientEventData
- Apply Smart Greenhouse design system
- Follow source tree: Models in `GroBroDomain/Models/`, Services in `GroBroDomain/Services/`, Views in `GroBroFeature/Nutrients/`
- Cost tracking helps growers budget and compare product economics
- Some growers spend $100-500 per grow cycle on nutrients

## Change Log
| Date       | Version | Description | Author |
|-----------|---------|-------------|--------|
| 2025-11-15 | 1.0     | Initial story creation per user request | Mary (BA) |
| 2025-11-15 | 1.1     | Added detailed task breakdown | James (Dev) |

## Dev Agent Record

### Agent Model Used
(To be filled during implementation)

### Debug Log References
(To be filled during implementation)

### Completion Notes List
(To be filled during implementation)

### File List
(To be filled during implementation)
