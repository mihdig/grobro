# Story 7.3: Device Pairing and Room Management

## Status

Approved

## Story

**As a** grower with multiple devices and grow spaces,
**I want** a unified UI to manage all device integrations and organize plants by room,
**so that** I can easily configure which sensors monitor which plants.

## Acceptance Criteria

1. Users can access "Device Integrations" from Settings showing all supported platforms (AC Infinity, Vivosun)
2. Each integration shows connection status, device count, and last sync timestamp
3. Users can tap an integration to see platform-specific settings (credentials, devices, etc.)
4. Users can create virtual "Grow Rooms" to organize plants by physical location
5. Users can assign devices to grow rooms (e.g., "Tent 1 Controller" → "Tent 1" room)
6. Users can assign plants to grow rooms
7. Environmental data from room devices automatically applies to all plants in that room
8. Users can override device assignment for individual plants (e.g., one plant has its own sensor)
9. Device list shows signal strength, battery level (if applicable), and last seen timestamp
10. Users can rename devices for easier identification ("Controller 1" → "Veg Tent AC")
11. Users can remove device pairings with confirmation dialog
12. UI clearly indicates which devices are actively syncing data to which plants

## Tasks / Subtasks

- [ ] Create Grow Room data model (AC: 4, 5, 6, 7)
  - [ ] Add `GrowRoom` model under `Domain/Models/`
  - [ ] Properties: id, name, description, devices[], plants[]
  - [ ] Add Core Data / SwiftData entity
  - [ ] Create `GrowRoomStore` for CRUD operations
- [ ] Build unified integrations list UI (AC: 1, 2, 3)
  - [ ] Create `DeviceIntegrationsView` under `Features/Settings/`
  - [ ] List all supported integrations (AC Infinity, Vivosun, future)
  - [ ] Show connection status badge (connected, disconnected, error)
  - [ ] Show device count per integration
  - [ ] Show last sync timestamp
  - [ ] Tap integration → navigate to platform-specific settings
- [ ] Build grow room management UI (AC: 4, 5, 6)
  - [ ] Create `GrowRoomsView` accessible from Settings
  - [ ] List all created rooms with plant/device counts
  - [ ] Add "Create Room" button
  - [ ] Room creation form: name, description, optional icon
  - [ ] Room detail view showing assigned plants and devices
  - [ ] Drag-and-drop or picker for assigning plants to rooms
  - [ ] Drag-and-drop or picker for assigning devices to rooms
- [ ] Build device detail and management UI (AC: 8, 9, 10, 11)
  - [ ] Create `DeviceDetailView` for individual devices
  - [ ] Show device info: type, model, firmware, signal, battery
  - [ ] Show last sync timestamp and status
  - [ ] Allow renaming device (inline edit or modal)
  - [ ] Show assigned room and plants
  - [ ] "Remove Device" button with confirmation dialog
  - [ ] "Override for Plant" option (device specific to one plant)
- [ ] Implement room-based data propagation (AC: 7, 12)
  - [ ] Update sync services to check plant's room assignment
  - [ ] If plant in room, sync data from room's devices
  - [ ] If plant has device override, use that instead
  - [ ] Show clear indicator in UI: "Data from: Veg Tent AC (via Tent 1 room)"
- [ ] Add visual indicators for device assignments (AC: 12)
  - [ ] Plant detail shows: "Environment data from: [Device Name]"
  - [ ] Device list shows: "Monitoring: 3 plants in Tent 1"
  - [ ] Room detail shows connections diagram
- [ ] Handle edge cases
  - [ ] Plant in room but room has no devices → show "No devices in room" message
  - [ ] Device assigned to multiple rooms → show warning, prevent or allow explicit
  - [ ] Deleting room with plants → prompt to reassign or move to "Unassigned"

## Dev Notes

### Architecture Context

This story creates the organizational layer on top of raw device integrations (7.1, 7.2), making multi-device setups manageable.

**Key Concepts:**
1. **Integration** - Platform connection (AC Infinity, Vivosun)
2. **Device** - Physical hardware (controller, sensor)
3. **Grow Room** - Virtual grouping of plants + devices
4. **Assignment** - Mapping between devices, rooms, and plants

**Data Relationships:**
```
Integration (1) → (Many) Devices
Grow Room (Many) ← (Many) Devices
Grow Room (1) → (Many) Plants
Plant (1) → (1 optional) Device Override
```

### Source Tree

```
GroBroPackage/
  Sources/
    GroBroDomain/
      Models/
        GrowRoom.swift                   # Room model
      Services/
        GrowRoomStore.swift              # Room CRUD
    GroBroFeature/
      Settings/
        Integrations/
          DeviceIntegrationsView.swift   # Main integrations list
          DeviceDetailView.swift         # Device detail/edit
        Rooms/
          GrowRoomsView.swift            # Room list
          GrowRoomDetailView.swift       # Room detail
          CreateRoomView.swift           # Room creation form
```

### Key Implementation Notes

1. **GrowRoom Model:**
   ```swift
   @Model
   final class GrowRoom {
       var id: UUID
       var name: String
       var description: String?
       var iconName: String? // SF Symbol name
       var deviceIds: [String] // Device IDs assigned to this room
       var plantIds: [UUID] // Plant IDs in this room
       var createdAt: Date
       var updatedAt: Date
   }
   ```

2. **Plant Model Extension:**
   ```swift
   extension Plant {
       var growRoomId: UUID? // Optional room assignment
       var deviceOverrideId: String? // Optional device override
   }
   ```

3. **Data Propagation Logic:**
   ```swift
   func syncEnvironmentalData(for plant: Plant, data: EnvironmentalData) {
       // Check device override first
       if let overrideDeviceId = plant.deviceOverrideId {
           // Use this specific device's data
       } else if let roomId = plant.growRoomId,
                 let room = growRoomStore.room(id: roomId) {
           // Use devices assigned to this room
           for deviceId in room.deviceIds {
               // Sync from each device in room
           }
       } else {
           // No automatic sync, manual logging only
       }
   }
   ```

4. **DeviceIntegrationsView UI:**
   ```swift
   List {
       Section("Connected Integrations") {
           IntegrationRow(
               name: "AC Infinity",
               status: acInfinityService.connectionStatus,
               deviceCount: acInfinityService.devices.count,
               lastSync: acInfinityService.lastSyncDate
           )

           IntegrationRow(
               name: "Vivosun",
               status: vivosunService.connectionStatus,
               deviceCount: vivosunService.devices.count,
               lastSync: vivosunService.lastSyncDate
           )
       }

       Section("Available Integrations") {
           Text("More integrations coming soon...")
       }
   }
   ```

5. **Room Assignment UI Patterns:**
   - Use picker for simple assignment
   - Use drag-and-drop for visual organization
   - Show clear visual hierarchy: Room → Devices → Plants

6. **Signal Strength Indicator:**
   ```swift
   func signalStrengthBars(rssi: Int) -> Int {
       // Convert RSSI to 0-4 bars
       // -50 to -60 dBm = 4 bars (excellent)
       // -60 to -70 dBm = 3 bars (good)
       // -70 to -80 dBm = 2 bars (fair)
       // -80 to -90 dBm = 1 bar (poor)
       // < -90 dBm = 0 bars (no signal)
   }
   ```

### Smart Greenhouse Design Integration

Apply design system from `docs/smart-greenhouse-design-spec.md`:

- **Device cards:** GlassCard with neon green border for connected, gray for disconnected
- **Signal strength:** Animated bars with color coding (green/yellow/red)
- **Room cards:** Glassmorphic with gradient background, plant/device counts
- **Connection status:** Glowing indicator (green = connected, red = error, gray = offline)
- **Last sync timestamp:** Monospaced font with tertiary text color

### Testing

- Unit tests:
  - GrowRoom CRUD operations
  - Device-to-room assignment logic
  - Plant-to-room assignment logic
  - Data propagation logic (room vs override)
- Integration tests:
  - Create room, assign devices, assign plants
  - Sync data flows to correct plants
  - Remove device updates affected plants
  - Delete room reassigns plants correctly
- Manual checks:
  - Create multiple rooms (Tent 1, Tent 2, Mother Room)
  - Assign multiple devices to each room
  - Assign plants to rooms
  - Verify environmental data flows correctly
  - Test device override on single plant
  - Test UI clarity (which device → which plants)

### UX Considerations

**Progressive Disclosure:**
- Simple use case: 1 room, 1 device, all plants → simple UI
- Complex use case: Multiple rooms, multiple devices → show advanced options

**Onboarding Tips:**
- First device pairing: "Create a Grow Room to organize your plants"
- First plant creation: "Assign to a Grow Room for automatic environmental tracking"

**Error Prevention:**
- Warn when deleting room with plants
- Warn when deleting device in use
- Prevent orphaned plants (always offer "Unassigned" room)

## Change Log

| Date       | Version | Description                      | Author |
|-----------|---------|----------------------------------|--------|
| 2025-11-15 | 1.0     | Initial story creation           | Mary (BA) |

## Dev Agent Record

*Awaiting implementation*
