# Story 10.1: Guides Section and Content Delivery

## Status

Approved

## Story

**As a** grower seeking educational resources,
**I want** access to curated guides and articles within the app,
**so that** I can learn best practices and improve my growing skills without leaving the app.

## Acceptance Criteria

1. Users can access "Guides" section from main navigation or settings
2. Guides are organized into categories: Getting Started, Plant Care, Troubleshooting, Advanced Topics
3. Each guide displays: title, estimated read time, difficulty level, last updated date
4. Guides support rich formatting: headings, lists, images, code blocks, tables
5. Content is delivered via CloudKit or similar (updateable without app update)
6. Guides load quickly with progressive rendering and caching
7. All content is accessible offline after first load
8. Each guide includes clear disclaimers about local law compliance and user responsibility
9. Guides can be favorited/bookmarked for quick access
10. Recently viewed guides appear in dedicated section
11. Share button allows sharing guide links
12. Analytics track which guides are most viewed to inform future content

## Tasks / Subtasks

- [ ] Create Guide data model (AC: 3, 9, 10)
  - [ ] Add `Guide` model under `Domain/Models/`
  - [ ] Properties: id, title, category, content_markdown, read_time_minutes, difficulty, last_updated, is_favorited, view_count
  - [ ] Store in Core Data / SwiftData with offline sync
- [ ] Build Guides list UI (AC: 1, 2, 3, 9, 10)
  - [ ] Create `GuidesListView` under `Features/Guides/`
  - [ ] Categorized sections (Getting Started, Plant Care, etc.)
  - [ ] Guide cards with glassmorphic styling
  - [ ] Display read time, difficulty badge, favorite star
  - [ ] Recently viewed section at top
  - [ ] Pull-to-refresh for content updates
- [ ] Implement content delivery system (AC: 5, 6, 7)
  - [ ] Create `GuideContentService` for fetching guides
  - [ ] Use CloudKit or JSON hosted on CDN
  - [ ] Cache content locally with URLCache
  - [ ] Background sync for content updates
  - [ ] Versioning system for content updates
- [ ] Build guide detail view (AC: 4, 8, 11)
  - [ ] Create `GuideDetailView` with markdown rendering
  - [ ] Use AttributedString or third-party markdown renderer
  - [ ] Support images with lazy loading
  - [ ] Disclaimer banner at top of each guide
  - [ ] Share button in navigation bar
  - [ ] Favorite button in navigation bar
- [ ] Implement favorites/bookmarks (AC: 9)
  - [ ] Toggle favorite on/off
  - [ ] Persist favorites locally
  - [ ] "Favorites" tab in Guides section
  - [ ] Sync favorites via iCloud (Pro feature)
- [ ] Track analytics (AC: 12)
  - [ ] Increment view_count on guide open
  - [ ] Track time spent reading
  - [ ] Track completion percentage (scroll depth)
  - [ ] Anonymous aggregated analytics only

## Dev Notes

### Architecture Context

This story creates the infrastructure for scalable, updateable educational content, setting the stage for Stories 10.3-10.6 to populate with actual guides.

**Content Strategy:**
- Start with 10-15 core guides (Story 10.3)
- Update quarterly with new content
- User feedback drives content priorities
- Localization-ready (future: Spanish, French)

### Source Tree

```
GroBroPackage/
  Sources/
    GroBroDomain/
      Models/
        Guide.swift                      # Guide model
        GuideCategory.swift              # Category enum
      Services/
        GuideContentService.swift        # Content delivery
    GroBroFeature/
      Guides/
        GuidesListView.swift             # Main list
        GuideDetailView.swift            # Detail/reader
        GuideCategorySection.swift       # Category section component
        GuideCardView.swift              # Individual card
```

### Key Implementation Notes

1. **Guide Model:**
   ```swift
   @Model
   final class Guide {
       var id: UUID
       var title: String
       var slug: String // URL-friendly identifier
       var category: GuideCategory
       var contentMarkdown: String
       var excerpt: String // Short description
       var readTimeMinutes: Int
       var difficulty: Difficulty
       var lastUpdated: Date
       var isFavorited: Bool
       var viewCount: Int
       var author: String?
       var tags: [String]

       enum Difficulty: String, Codable {
           case beginner, intermediate, advanced
       }

       enum GuideCategory: String, Codable, CaseIterable {
           case gettingStarted = "Getting Started"
           case plantCare = "Plant Care"
           case troubleshooting = "Troubleshooting"
           case advancedTopics = "Advanced Topics"
           case safety = "Safety & Legal"

           var icon: String {
               switch self {
               case .gettingStarted: return "book.fill"
               case .plantCare: return "leaf.fill"
               case .troubleshooting: return "wrench.and.screwdriver.fill"
               case .advancedTopics: return "graduationcap.fill"
               case .safety: return "shield.fill"
               }
           }
       }
   }
   ```

2. **GuideContentService:**
   ```swift
   @Observable
   final class GuideContentService {
       private let cloudKitContainer = CKContainer(identifier: "iCloud.com.yourapp.grobro")
       private let cache = URLCache.shared

       func fetchAllGuides() async throws -> [Guide] {
           // Fetch from CloudKit public database
           let database = cloudKitContainer.publicCloudDatabase
           let query = CKQuery(recordType: "Guide", predicate: NSPredicate(value: true))

           let results = try await database.records(matching: query)
           return results.matchResults.compactMap { try? $0.1.get() }
               .map { record in
                   Guide(
                       id: UUID(uuidString: record["id"] as! String)!,
                       title: record["title"] as! String,
                       contentMarkdown: record["content"] as! String,
                       // ... map all fields
                   )
               }
       }

       func syncGuidesInBackground() async {
           // Background sync for updates
           // Check version, download only changed guides
       }
   }
   ```

3. **GuidesListView UI:**
   ```swift
   struct GuidesListView: View {
       @Query private var guides: [Guide]
       @State private var selectedCategory: GuideCategory?

       var body: some View {
           NavigationStack {
               ScrollView {
                   LazyVStack(spacing: 16) {
                       // Recently viewed
                       if !recentlyViewed.isEmpty {
                           GuideCategorySection(
                               title: "Recently Viewed",
                               icon: "clock.fill",
                               guides: recentlyViewed
                           )
                       }

                       // Favorites
                       if !favorites.isEmpty {
                           GuideCategorySection(
                               title: "Favorites",
                               icon: "star.fill",
                               guides: favorites
                           )
                       }

                       // Categories
                       ForEach(GuideCategory.allCases, id: \.self) { category in
                           GuideCategorySection(
                               title: category.rawValue,
                               icon: category.icon,
                               guides: guides.filter { $0.category == category }
                           )
                       }
                   }
                   .padding()
               }
               .background(Color.deepBackground)
               .navigationTitle("Guides")
           }
       }

       var recentlyViewed: [Guide] {
           guides.filter { $0.viewCount > 0 }
               .sorted { $0.lastViewedDate! > $1.lastViewedDate! }
               .prefix(3)
               .map { $0 }
       }

       var favorites: [Guide] {
           guides.filter { $0.isFavorited }
       }
   }
   ```

4. **GuideCardView:**
   ```swift
   struct GuideCardView: View {
       let guide: Guide

       var body: some View {
           NavigationLink(destination: GuideDetailView(guide: guide)) {
               GlassCard(padding: 16) {
                   HStack(spacing: 12) {
                       // Icon
                       Image(systemName: guide.category.icon)
                           .font(.system(size: 32))
                           .foregroundColor(.electricGreen)
                           .frame(width: 50, height: 50)

                       VStack(alignment: .leading, spacing: 6) {
                           Text(guide.title)
                               .font(.system(size: 16, weight: .semibold))
                               .foregroundColor(.primaryText)
                               .lineLimit(2)

                           Text(guide.excerpt)
                               .font(.system(size: 13))
                               .foregroundColor(.secondaryText)
                               .lineLimit(2)

                           HStack(spacing: 12) {
                               // Read time
                               Label("\(guide.readTimeMinutes) min", systemImage: "clock")
                                   .font(.system(size: 11))
                                   .foregroundColor(.tertiaryText)

                               // Difficulty badge
                               DifficultyBadge(difficulty: guide.difficulty)

                               Spacer()

                               // Favorite star
                               if guide.isFavorited {
                                   Image(systemName: "star.fill")
                                       .foregroundColor(.goldElectric)
                                       .font(.system(size: 14))
                               }
                           }
                       }

                       Image(systemName: "chevron.right")
                           .foregroundColor(.tertiaryText)
                   }
               }
           }
       }
   }
   ```

5. **GuideDetailView with Markdown:**
   ```swift
   import MarkdownUI // or AttributedString

   struct GuideDetailView: View {
       @Bindable var guide: Guide
       @Environment(\.dismiss) private var dismiss

       var body: some View {
           ScrollView {
               VStack(alignment: .leading, spacing: 20) {
                   // Disclaimer banner
                   DisclaimerBanner()

                   // Content
                   Markdown(guide.contentMarkdown)
                       .markdownTheme(.groBro)
                       .padding()
               }
           }
           .background(Color.deepBackground)
           .navigationTitle(guide.title)
           .navigationBarTitleDisplayMode(.inline)
           .toolbar {
               ToolbarItem(placement: .topBarTrailing) {
                   HStack {
                       // Favorite button
                       Button {
                           guide.isFavorited.toggle()
                       } label: {
                           Image(systemName: guide.isFavorited ? "star.fill" : "star")
                               .foregroundColor(guide.isFavorited ? .goldElectric : .secondaryText)
                       }

                       // Share button
                       ShareLink(item: shareURL) {
                           Image(systemName: "square.and.arrow.up")
                               .foregroundColor(.secondaryText)
                       }
                   }
               }
           }
           .task {
               // Track view
               guide.viewCount += 1
               guide.lastViewedDate = Date()
           }
       }

       var shareURL: URL {
           URL(string: "grobro://guides/\(guide.slug)")!
       }
   }
   ```

### Smart Greenhouse Design Integration

**Guide Cards:**
- GlassCard with green accent
- Category icon with neon glow
- Difficulty badge (glassmorphic chip)
- Read time with clock icon

**Detail View:**
- Deep background
- Markdown with custom theme (neon links, code blocks)
- Disclaimer banner (glassmorphic, orange gradient)

### Content Format Example

```markdown
# How to Maintain Your Plant Diary

**Read time:** 5 minutes | **Difficulty:** Beginner

## Introduction

A well-maintained plant diary is your most valuable tool for tracking progress and diagnosing issues...

## Key Events to Log

1. **Watering** - Note frequency and amount
2. **Feeding** - Record nutrients and dosage
3. **Growth milestones** - Stage transitions, topping, LST

## Photos Are Essential

Take photos from same angle and distance for accurate comparison...

> **Legal Disclaimer:** Users are solely responsible for compliance with local laws. GroBro does not encourage or facilitate illegal activity.
```

### Testing

- Unit tests:
  - Guide model CRUD operations
  - Content sync and caching
  - Favorite persistence
- Integration tests:
  - Fetch guides from CloudKit
  - Offline access after first load
  - Analytics tracking
- Manual checks:
  - Test on slow network (progressive loading)
  - Test offline mode
  - Verify disclaimers display
  - Test markdown rendering (all formats)
  - Share link works

## Change Log

| Date       | Version | Description                      | Author |
|-----------|---------|----------------------------------|--------|
| 2025-11-15 | 1.0     | Initial story creation           | Mary (BA) |

## Dev Agent Record

*Awaiting implementation*
