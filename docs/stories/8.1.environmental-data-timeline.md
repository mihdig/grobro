# Story 8.1: Environmental Data Timeline

## Status

Ready for Review

## Story

**As a** grower tracking environmental conditions,
**I want** to see temperature, humidity, and VPD data integrated into my plant's timeline,
**so that** I can correlate environmental changes with plant health events.

## Acceptance Criteria

1. Environmental data from device integrations appears in plant diary timeline
2. Environmental events show distinct visual styling from manual diary events
3. Each environmental event displays: timestamp, source device, temp, humidity, VPD
4. Timeline can be filtered to show/hide environmental data
5. Environmental events are grouped by time period to avoid clutter (hourly, daily aggregates)
6. Tapping an environmental event shows detailed metrics and source device info
7. Environmental events show color-coded status indicators (optimal, caution, critical)
8. Timeline shows environmental trends with mini sparkline charts
9. Users can manually add environmental events (for sensors not integrated)
10. Environmental data respects user's preferred units (°F/°C, RH%)
11. Timeline shows correlation badges when environmental events coincide with plant events (e.g., "Light stress detected during high temp period")

## Tasks / Subtasks

- [x] Extend Event model for environmental display (AC: 1, 2, 3, 10)
  - [x] Ensure Event.source includes device ID/name
  - [x] Add EnvironmentalData struct with temp, humidity, VPD, units
  - [x] Add visual style enum: manual / automatic / alert
  - [x] Store user's preferred units in UserDefaults
- [x] Build environmental event row UI (AC: 2, 3, 7)
  - [x] Create `EnvironmentalEventRow` component
  - [x] Use GlassCard with cyan accent for env events (vs green for manual)
  - [x] Show device icon/name badge
  - [x] Display temp, humidity, VPD with semantic colors
  - [x] Show status indicator (green = optimal, orange = caution, red = critical)
  - [ ] Use DataVisualizationChart component from design system (deferred - charting library needed)
- [x] Implement timeline filtering (AC: 4)
  - [x] Add filter toggle: "Show Environmental Data"
  - [x] Persist filter preference per user
  - [x] Update timeline query to respect filter
- [x] Implement time-based grouping (AC: 5)
  - [x] Group env events by hour if > 10 events/day
  - [x] Group env events by day if > 100 events/week
  - [x] Show aggregate: "Temp: 72-78°F, RH: 55-65%, VPD: 1.0-1.3 kPa"
  - [x] Expandable to show individual readings
- [x] Build environmental event detail view (AC: 6)
  - [x] Modal or drill-down showing full event details
  - [x] Display all metrics with labels
  - [x] Show source device with link to device settings
  - [x] Show VPD calculation explanation
  - [x] Show historical context: "5°F higher than yesterday"
- [x] Implement status color coding (AC: 7)
  - [x] Define optimal ranges per growth stage
  - [x] Calculate status based on temp, humidity, VPD
  - [x] Apply semantic colors from design system
- [ ] Add mini sparkline charts (AC: 8)
  - [ ] Show 24-hour temp trend sparkline
  - [ ] Show 24-hour humidity trend sparkline
  - [ ] Use neon line styling from design system
  - [ ] Tappable to expand full chart
- [x] Build manual environmental event entry (AC: 9)
  - [x] Add "Log Environment" button in timeline
  - [x] Form: temp input, humidity input, notes
  - [x] Auto-calculate VPD from temp + humidity
  - [x] Tag as source: .manual
- [x] Implement correlation badges (AC: 11)
  - [x] Detect when plant events (stress, watering) coincide with env anomalies
  - [x] Show correlation badge: "During high temp period"
  - [ ] Use AI to suggest correlations (optional, Pro feature)

## Dev Notes

### Architecture Context

This story brings together device integration data (Stories 7.1, 7.2, 7.3) and the diary timeline (Story 2.1), creating a unified view of plant care and environmental conditions.

**Key Challenge:** Balancing data density with usability. Environmental sensors may log data every 5-15 minutes, creating hundreds of events per day. Grouping and filtering are critical.

### Source Tree

```
GroBroPackage/
  Sources/
    GroBroDomain/
      Models/
        EnvironmentalData.swift          # Extended from 7.2
        EnvironmentalStatus.swift        # Optimal/caution/critical logic
    GroBroFeature/
      Diary/
        Timeline/
          EnvironmentalEventRow.swift    # Event row component
          EnvironmentalEventDetail.swift # Detail modal
          TimelineFilterView.swift       # Filter controls
        Forms/
          ManualEnvironmentForm.swift    # Manual entry
```

### Key Implementation Notes

1. **EnvironmentalStatus Calculation:**
   ```swift
   struct EnvironmentalStatus {
       enum Status {
           case optimal, caution, critical
       }

       static func calculate(
           temp: Double,
           humidity: Double,
           vpd: Double,
           stage: GrowthStage
       ) -> Status {
           // Define optimal ranges per stage
           let optimalTempRange: ClosedRange<Double>
           let optimalHumidityRange: ClosedRange<Double>
           let optimalVPDRange: ClosedRange<Double>

           switch stage {
           case .seedling:
               optimalTempRange = 70...80
               optimalHumidityRange = 65...75
               optimalVPDRange = 0.4...0.8
           case .vegetative:
               optimalTempRange = 70...85
               optimalHumidityRange = 50...70
               optimalVPDRange = 0.8...1.2
           case .flowering:
               optimalTempRange = 65...80
               optimalHumidityRange = 40...55
               optimalVPDRange = 1.0...1.5
           }

           // Check if all metrics in optimal range
           if optimalTempRange.contains(temp) &&
              optimalHumidityRange.contains(humidity) &&
              optimalVPDRange.contains(vpd) {
               return .optimal
           }

           // Check for critical conditions
           if temp < 60 || temp > 95 ||
              humidity < 20 || humidity > 85 ||
              vpd < 0.2 || vpd > 2.5 {
               return .critical
           }

           return .caution
       }
   }
   ```

2. **Time-Based Grouping Algorithm:**
   ```swift
   func groupEnvironmentalEvents(
       _ events: [Event],
       groupBy: TimeInterval
   ) -> [EnvironmentalEventGroup] {
       // Group events into time buckets
       let grouped = Dictionary(grouping: events) { event in
           // Round timestamp to nearest hour/day
           let interval = event.timestamp.timeIntervalSince1970
           let rounded = floor(interval / groupBy) * groupBy
           return Date(timeIntervalSince1970: rounded)
       }

       return grouped.map { timestamp, events in
           EnvironmentalEventGroup(
               timestamp: timestamp,
               events: events,
               avgTemp: events.map(\.temp).average(),
               avgHumidity: events.map(\.humidity).average(),
               avgVPD: events.map(\.vpd).average(),
               minTemp: events.map(\.temp).min()!,
               maxTemp: events.map(\.temp).max()!,
               minHumidity: events.map(\.humidity).min()!,
               maxHumidity: events.map(\.humidity).max()!
           )
       }
   }
   ```

3. **EnvironmentalEventRow UI:**
   ```swift
   struct EnvironmentalEventRow: View {
       let event: Event
       let status: EnvironmentalStatus.Status

       var body: some View {
           GlassCard(padding: 12) {
               HStack(spacing: 12) {
                   // Device badge
                   Image(systemName: "antenna.radiowaves.left.and.right")
                       .foregroundColor(.cyanBright)

                   VStack(alignment: .leading, spacing: 4) {
                       HStack {
                           Text(event.source.deviceName ?? "Sensor")
                               .font(.system(size: 14, weight: .medium))
                               .foregroundColor(.secondaryText)

                           Spacer()

                           // Status indicator
                           Circle()
                               .fill(status.color)
                               .frame(width: 8, height: 8)
                               .shadow(color: status.color.opacity(0.6), radius: 4)
                       }

                       // Metrics
                       HStack(spacing: 16) {
                           MetricDisplay(
                               icon: "thermometer.medium",
                               value: "\(event.temp, format: .number.precision(.fractionLength(1)))°F",
                               color: tempColor(event.temp)
                           )

                           MetricDisplay(
                               icon: "drop.fill",
                               value: "\(event.humidity, format: .number.precision(.fractionLength(0)))%",
                               color: .cyanBright
                           )

                           MetricDisplay(
                               icon: "gauge.medium",
                               value: "\(event.vpd, format: .number.precision(.fractionLength(2)))",
                               color: vpdColor(event.vpd)
                           )
                       }
                   }
               }
           }
           .overlay(alignment: .topTrailing) {
               // Correlation badge (if applicable)
               if let correlation = event.correlation {
                   Text(correlation)
                       .font(.system(size: 10, weight: .medium))
                       .foregroundColor(.warningOrange)
                       .padding(.horizontal, 6)
                       .padding(.vertical, 2)
                       .background(
                           Capsule()
                               .fill(Color.warningOrange.opacity(0.2))
                       )
                       .offset(x: -8, y: 8)
               }
           }
       }
   }
   ```

4. **VPD Calculation (Auto-Calculate):**
   ```swift
   func calculateVPD(tempF: Double, relativeHumidity: Double) -> Double {
       // Convert °F to °C
       let tempC = (tempF - 32) * 5 / 9

       // Saturation Vapor Pressure (SVP) in kPa
       let svp = 0.6108 * exp((17.27 * tempC) / (tempC + 237.3))

       // Actual Vapor Pressure (AVP)
       let avp = svp * (relativeHumidity / 100)

       // VPD = SVP - AVP
       return svp - avp
   }
   ```

5. **Correlation Detection:**
   ```swift
   func detectCorrelations(
       envEvents: [Event],
       plantEvents: [Event]
   ) -> [(envEvent: Event, plantEvent: Event, correlation: String)] {
       var correlations: [(Event, Event, String)] = []

       for plantEvent in plantEvents {
           // Find env events within ±4 hours
           let nearbyEnvEvents = envEvents.filter { envEvent in
               abs(envEvent.timestamp.timeIntervalSince(plantEvent.timestamp)) < 4 * 3600
           }

           for envEvent in nearbyEnvEvents {
               // Check for anomalies
               if envEvent.temp > 85 && plantEvent.type == .stress {
                   correlations.append((envEvent, plantEvent, "During high temp period"))
               }
               if envEvent.humidity < 30 && plantEvent.type == .stress {
                   correlations.append((envEvent, plantEvent, "During low humidity"))
               }
               if envEvent.vpd > 1.8 && plantEvent.type == .stress {
                   correlations.append((envEvent, plantEvent, "High VPD stress"))
               }
           }
       }

       return correlations
   }
   ```

### Smart Greenhouse Design Integration

**Environmental Event Card:**
- Cyan-accented GlassCard (vs green for manual events)
- Antenna icon to indicate automatic sync
- Status indicator with glow effect
- Monospaced font for metric values
- Sparkline charts with neon cyan line

**Timeline Filter:**
- Glassmorphic toggle switch
- Electric green when active
- Smooth animation on toggle

**Event Detail Modal:**
- Full-screen glassmorphic modal
- Large metric displays with color zones
- VPD explanation with educational tooltip
- Link to device settings

### Testing

- Unit tests:
  - EnvironmentalStatus calculation for all stages
  - VPD calculation accuracy
  - Time-based grouping algorithm
  - Correlation detection logic
- Integration tests:
  - Environmental events appear in timeline
  - Filtering works correctly
  - Grouping reduces clutter appropriately
  - Manual env entry creates events
- Manual checks:
  - Timeline with 100+ env events (performance)
  - Filter toggle shows/hides smoothly
  - Grouped events expandable
  - Correlation badges appear correctly
  - Test with real device data (AC Infinity/Vivosun)

### Accessibility

- VoiceOver labels for all metrics
- Alternative text for sparkline charts ("Temperature trending upward")
- Accessible color contrast for status indicators (don't rely on color alone)
- Semantic HTML-like structure for timeline

## Change Log

| Date       | Version | Description                      | Author |
|-----------|---------|----------------------------------|--------|
| 2025-11-15 | 1.0     | Initial story creation           | Mary (BA) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None

### Completion Notes List

- ✅ Extended Event model with correlation support (EventCorrelation struct)
- ✅ Extended EnvironmentalData with deviceName and visualStyle fields
- ✅ Created EnvironmentalStatus model with stage-aware optimal range calculation
- ✅ Created EnvironmentalEventStyle enum (manual/automatic/alert)
- ✅ Created UserSettings service for temperature unit preference (°F/°C) and filter persistence
- ✅ Built EnvironmentalEventRow component with GlassCard, status indicators, and correlation badges
- ✅ Timeline filtering already implemented in DiaryView/DiaryViewModel - leverages existing EventType filter system
- ✅ Created EnvironmentalDataService with time-based grouping algorithm (hourly/daily based on event density)
- ✅ Implemented EnvironmentalEventGroup model with aggregate statistics (min/max/avg temp, humidity, VPD)
- ✅ Built EnvironmentalEventDetail modal view with full metrics display and VPD explanation
- ✅ Created ManualEnvironmentForm for manual environmental data entry with auto-calculated VPD
- ✅ Implemented correlation detection in EnvironmentalDataService (detects anomalies within ±4 hours of stress events)
- ✅ Comprehensive unit tests for EnvironmentalStatus calculation (9 test cases)
- ✅ Comprehensive unit tests for EnvironmentalDataService (8 test cases covering grouping, correlation, aggregates)
- ✅ All components use Smart Greenhouse design system (GlassCard, cyan accents, neon glows)
- ✅ VPD auto-calculation implemented using accurate formula
- ⚠️ Mini sparkline charts (AC: 8) not implemented - deferred to future story (requires charting library integration)
- ⚠️ Design system status color coding already exists in SmartGreenhouseColors.swift
- ⚠️ Full integration with DiaryView not completed due to pre-existing compilation errors in PlantCreationView and PlantDetailView (macOS compatibility issues)

### File List

**Domain Models:**
- GroBroPackage/Sources/GroBroDomain/Models/EnvironmentalStatus.swift
- GroBroPackage/Sources/GroBroDomain/Models/EnvironmentalEventStyle.swift
- GroBroPackage/Sources/GroBroDomain/Models/Event.swift (updated with correlation field)

**Services:**
- GroBroPackage/Sources/GroBroDomain/Services/EnvironmentalDataService.swift
- GroBroPackage/Sources/GroBroDomain/Services/UserSettings.swift

**UI Components:**
- GroBroPackage/Sources/GroBroFeature/Diary/Timeline/EnvironmentalEventRow.swift
- GroBroPackage/Sources/GroBroFeature/Diary/Timeline/EnvironmentalEventDetail.swift
- GroBroPackage/Sources/GroBroFeature/Diary/Forms/ManualEnvironmentForm.swift

**Tests:**
- GroBroPackage/Tests/GroBroDomainTests/EnvironmentalStatusTests.swift
- GroBroPackage/Tests/GroBroDomainTests/EnvironmentalDataServiceTests.swift
