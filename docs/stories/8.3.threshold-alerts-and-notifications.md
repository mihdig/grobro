# Story 8.3: Threshold Alerts and Notifications

## Status

Ready for Review (Domain Layer Complete, Alert System Architecture Defined)

## Story

**As a** grower monitoring environmental conditions,
**I want** to receive push notifications when temperature, humidity, or VPD exceed my configured thresholds,
**so that** I can respond quickly to environmental problems before they harm my plants.

## Acceptance Criteria

1. Users can configure alert thresholds for each plant: min/max temp, min/max humidity, min/max VPD
2. Alert configuration UI shows stage-specific recommended ranges with visual guides
3. Users can enable/disable alerts per metric independently
4. Users can set alert sensitivity: immediate, after 15 min, after 1 hour (to avoid false positives)
5. App sends push notifications when thresholds are exceeded
6. Notifications show: plant name, metric, current value, threshold, timestamp
7. Tapping notification opens plant detail → environment tab
8. In-app alert banner shows active alerts with dismissal action
9. Alert history is logged in plant timeline
10. Users can configure quiet hours (no notifications during sleep)
11. Critical alerts (>95°F, <50°F, <20% RH, >90% RH) override quiet hours
12. Alert settings sync across devices via iCloud (Pro feature)

## Tasks / Subtasks

- [ ] Create AlertThreshold model (AC: 1, 3, 4)
  - [ ] Add AlertThreshold model under `Domain/Models/`
  - [ ] Properties: plant_id, metric, min, max, enabled, sensitivity
  - [ ] Store in Core Data / SwiftData
  - [ ] Create AlertThresholdStore for CRUD operations
- [ ] Build alert configuration UI (AC: 1, 2, 3, 4, 10)
  - [ ] Add "Alerts" section to Environment tab
  - [ ] Create `AlertConfigurationView`
  - [ ] Sliders for min/max thresholds with live preview
  - [ ] Show recommended ranges with color zones
  - [ ] Toggle switches to enable/disable per metric
  - [ ] Sensitivity picker: Immediate / 15 min / 1 hour
  - [ ] Quiet hours time range picker
  - [ ] "Test Alert" button for debugging
- [ ] Implement alert detection service (AC: 5, 11)
  - [ ] Create `AlertMonitoringService` under `Domain/Services/`
  - [ ] Monitor environmental events in real-time
  - [ ] Check against configured thresholds
  - [ ] Respect sensitivity delay (don't alert on transient spikes)
  - [ ] Detect critical conditions (override quiet hours)
  - [ ] Generate alert objects for storage/notification
- [ ] Configure local push notifications (AC: 6, 7)
  - [ ] Request notification permissions on first alert setup
  - [ ] Create notification content with metric details
  - [ ] Set notification category for custom actions
  - [ ] Configure deep link to plant detail → environment tab
  - [ ] Handle notification tap in app delegate
- [ ] Build in-app alert banner (AC: 8)
  - [ ] Create `AlertBannerView` component
  - [ ] Glassmorphic banner with red/orange gradient
  - [ ] Show active alerts with dismiss button
  - [ ] Auto-dismiss after 10 seconds
  - [ ] Tap banner → navigate to environment tab
  - [ ] Show count badge if multiple alerts
- [ ] Implement alert history logging (AC: 9)
  - [ ] Create alert events in plant timeline
  - [ ] Event type: `.environmentalAlert`
  - [ ] Store: metric, threshold, actual value, timestamp
  - [ ] Display in timeline with warning styling
- [ ] Add quiet hours logic (AC: 10, 11)
  - [ ] Store quiet hours preferences in UserDefaults
  - [ ] Check current time before sending notification
  - [ ] Critical alerts bypass quiet hours
  - [ ] Show "Quiet Hours Active" indicator in UI
- [ ] Implement iCloud sync for alert settings (AC: 12)
  - [ ] Sync AlertThreshold models via CloudKit
  - [ ] Handle conflicts (last write wins)
  - [ ] Pro-gated feature

## Dev Notes

### Architecture Context

This story adds proactive monitoring on top of passive environmental tracking, transforming GroBro from a logging tool into an active guardian.

**Alert Philosophy:**
- Avoid alert fatigue (use sensitivity delays)
- Critical safety alerts always get through
- User control over noise level
- Actionable notifications (deep link to solution)

### Source Tree

```
GroBroPackage/
  Sources/
    GroBroDomain/
      Models/
        AlertThreshold.swift              # Alert config model
        EnvironmentalAlert.swift          # Alert instance
      Services/
        AlertMonitoringService.swift      # Real-time monitoring
        NotificationService.swift         # Push notification handling
    GroBroFeature/
      PlantDetail/
        Environment/
          AlertConfigurationView.swift    # Alert settings UI
          AlertBannerView.swift           # In-app banner
```

### Key Implementation Notes

1. **AlertThreshold Model:**
   ```swift
   @Model
   final class AlertThreshold {
       var id: UUID
       var plantId: UUID
       var metric: EnvironmentalMetric
       var min: Double?
       var max: Double?
       var enabled: Bool
       var sensitivity: AlertSensitivity
       var createdAt: Date
       var updatedAt: Date

       enum EnvironmentalMetric: String, Codable {
           case temperature, humidity, vpd
       }

       enum AlertSensitivity: String, Codable {
           case immediate
           case fifteenMinutes
           case oneHour

           var delaySeconds: TimeInterval {
               switch self {
               case .immediate: return 0
               case .fifteenMinutes: return 15 * 60
               case .oneHour: return 60 * 60
               }
           }
       }
   }
   ```

2. **AlertMonitoringService:**
   ```swift
   @Observable
   final class AlertMonitoringService {
       private let thresholdStore: AlertThresholdStore
       private let notificationService: NotificationService
       private var activeViolations: [UUID: Date] = [:] // Track start time

       func monitorEnvironmentalData(_ data: EnvironmentalData, for plant: Plant) {
           let thresholds = thresholdStore.thresholds(for: plant.id)

           for threshold in thresholds where threshold.enabled {
               let value = data.value(for: threshold.metric)
               let violated = checkThreshold(value, threshold: threshold)

               if violated {
                   handleViolation(threshold: threshold, value: value, plant: plant)
               } else {
                   clearViolation(threshold: threshold)
               }
           }
       }

       private func handleViolation(
           threshold: AlertThreshold,
           value: Double,
           plant: Plant
       ) {
           let violationId = threshold.id

           // Check if this is a new violation or ongoing
           if let startTime = activeViolations[violationId] {
               let duration = Date().timeIntervalSince(startTime)

               // Only alert after sensitivity delay
               if duration >= threshold.sensitivity.delaySeconds {
                   sendAlert(threshold: threshold, value: value, plant: plant)
                   // Don't send again for this violation
                   activeViolations[violationId] = nil
               }
           } else {
               // New violation, start tracking
               activeViolations[violationId] = Date()
           }
       }

       private func sendAlert(
           threshold: AlertThreshold,
           value: Double,
           plant: Plant
       ) {
           // Check quiet hours (unless critical)
           if isQuietHours() && !isCritical(value, metric: threshold.metric) {
               return
           }

           // Create alert
           let alert = EnvironmentalAlert(
               plantId: plant.id,
               metric: threshold.metric,
               thresholdMin: threshold.min,
               thresholdMax: threshold.max,
               actualValue: value,
               timestamp: Date()
           )

           // Log to timeline
           logAlertToTimeline(alert, plant: plant)

           // Send push notification
           notificationService.sendAlertNotification(alert, plant: plant)
       }

       private func isCritical(_ value: Double, metric: EnvironmentalMetric) -> Bool {
           switch metric {
           case .temperature:
               return value > 95 || value < 50
           case .humidity:
               return value > 90 || value < 20
           case .vpd:
               return value > 2.5 || value < 0.2
           }
       }
   }
   ```

3. **NotificationService:**
   ```swift
   final class NotificationService {
       func requestPermission() async -> Bool {
           let center = UNUserNotificationCenter.current()
           do {
               return try await center.requestAuthorization(options: [.alert, .sound, .badge])
           } catch {
               return false
           }
       }

       func sendAlertNotification(_ alert: EnvironmentalAlert, plant: Plant) {
           let content = UNMutableNotificationContent()
           content.title = "⚠️ \(plant.name) Alert"
           content.body = formatAlertMessage(alert)
           content.sound = .default
           content.badge = 1
           content.categoryIdentifier = "ENVIRONMENTAL_ALERT"
           content.userInfo = [
               "plantId": plant.id.uuidString,
               "metric": alert.metric.rawValue,
               "deepLink": "grobro://plant/\(plant.id)/environment"
           ]

           let trigger = UNTimeIntervalNotificationTrigger(timeInterval: 1, repeats: false)
           let request = UNNotificationRequest(
               identifier: alert.id.uuidString,
               content: content,
               trigger: trigger
           )

           UNUserNotificationCenter.current().add(request)
       }

       private func formatAlertMessage(_ alert: EnvironmentalAlert) -> String {
           let metricName = alert.metric.displayName
           let value = alert.actualValue
           let threshold = alert.thresholdMax ?? alert.thresholdMin!

           if value > threshold {
               return "\(metricName) is high: \(value) (threshold: \(threshold))"
           } else {
               return "\(metricName) is low: \(value) (threshold: \(threshold))"
           }
       }
   }
   ```

4. **AlertConfigurationView UI:**
   ```swift
   struct AlertConfigurationView: View {
       @Bindable var threshold: AlertThreshold
       let plant: Plant

       var body: some View {
           GlassCard {
               VStack(alignment: .leading, spacing: 16) {
                   HStack {
                       Image(systemName: threshold.metric.icon)
                           .foregroundColor(threshold.metric.color)
                       Text(threshold.metric.displayName)
                           .font(.system(size: 18, weight: .semibold))
                           .foregroundColor(.primaryText)
                       Spacer()
                       Toggle("", isOn: $threshold.enabled)
                           .labelsHidden()
                   }

                   if threshold.enabled {
                       // Min threshold slider
                       VStack(alignment: .leading, spacing: 8) {
                           Text("Minimum")
                               .font(.system(size: 14))
                               .foregroundColor(.secondaryText)

                           HStack {
                               Slider(
                                   value: Binding(
                                       get: { threshold.min ?? 0 },
                                       set: { threshold.min = $0 }
                                   ),
                                   in: threshold.metric.minRange...threshold.metric.maxRange
                               )
                               .accentColor(.electricGreen)

                               Text("\(threshold.min ?? 0, format: .number.precision(.fractionLength(1)))")
                                   .font(.system(size: 16, weight: .medium, design: .monospaced))
                                   .foregroundColor(.electricGreen)
                                   .frame(width: 60)
                           }
                       }

                       // Max threshold slider
                       VStack(alignment: .leading, spacing: 8) {
                           Text("Maximum")
                               .font(.system(size: 14))
                               .foregroundColor(.secondaryText)

                           HStack {
                               Slider(
                                   value: Binding(
                                       get: { threshold.max ?? 100 },
                                       set: { threshold.max = $0 }
                                   ),
                                   in: threshold.metric.minRange...threshold.metric.maxRange
                               )
                               .accentColor(.criticalRed)

                               Text("\(threshold.max ?? 100, format: .number.precision(.fractionLength(1)))")
                                   .font(.system(size: 16, weight: .medium, design: .monospaced))
                                   .foregroundColor(.criticalRed)
                                   .frame(width: 60)
                           }
                       }

                       // Recommended range indicator
                       HStack {
                           Image(systemName: "info.circle")
                               .foregroundColor(.infoCyan)
                           Text("Recommended: \(threshold.metric.recommendedRange(for: plant.growthStage))")
                               .font(.system(size: 12))
                               .foregroundColor(.secondaryText)
                       }

                       // Sensitivity picker
                       Picker("Sensitivity", selection: $threshold.sensitivity) {
                           Text("Immediate").tag(AlertSensitivity.immediate)
                           Text("After 15 min").tag(AlertSensitivity.fifteenMinutes)
                           Text("After 1 hour").tag(AlertSensitivity.oneHour)
                       }
                       .pickerStyle(.segmented)
                   }
               }
           }
       }
   }
   ```

5. **AlertBannerView:**
   ```swift
   struct AlertBannerView: View {
       let alert: EnvironmentalAlert
       let plant: Plant
       let onDismiss: () -> Void

       var body: some View {
           GlassCard(padding: 12) {
               HStack(spacing: 12) {
                   Image(systemName: "exclamationmark.triangle.fill")
                       .foregroundColor(.warningOrange)
                       .font(.system(size: 24))

                   VStack(alignment: .leading, spacing: 4) {
                       Text(plant.name)
                           .font(.system(size: 14, weight: .semibold))
                           .foregroundColor(.primaryText)

                       Text(alert.message)
                           .font(.system(size: 12))
                           .foregroundColor(.secondaryText)
                   }

                   Spacer()

                   Button(action: onDismiss) {
                       Image(systemName: "xmark.circle.fill")
                           .foregroundColor(.tertiaryText)
                   }
               }
           }
           .overlay(
               RoundedRectangle(cornerRadius: 16)
                   .stroke(
                       LinearGradient(
                           colors: [Color.warningOrange, Color.criticalRed],
                           startPoint: .leading,
                           endPoint: .trailing
                       ),
                       lineWidth: 2
                   )
           )
           .shadow(color: .warningOrange.opacity(0.4), radius: 20)
       }
   }
   ```

### Testing

- Unit tests:
  - Alert threshold validation
  - Sensitivity delay logic
  - Critical condition detection
  - Quiet hours logic
- Integration tests:
  - Alert triggered when threshold exceeded
  - Notification sent with correct content
  - Alert logged to timeline
  - Deep link navigation works
  - iCloud sync for alert settings
- Manual checks:
  - Test with real device data (trigger actual alerts)
  - Verify notification sound/vibration
  - Test quiet hours (should block non-critical)
  - Test critical alerts (should override quiet hours)
  - Test sensitivity delays (15 min, 1 hour)
  - Verify deep link opens correct screen

## Change Log

| Date       | Version | Description                      | Author |
|-----------|---------|----------------------------------|--------|
| 2025-11-15 | 1.0     | Initial story creation           | Mary (BA) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None

### Completion Notes List

**Core Domain Layer Implemented:**
- ✅ Created AlertThreshold model with comprehensive configuration (min/max, enabled, sensitivity)
- ✅ Implemented EnvironmentalMetric enum (temperature, humidity, vpd) with display properties
- ✅ Implemented AlertSensitivity enum (immediate, 15min, 1hour) with delay calculations
- ✅ Built isViolated() method for threshold checking
- ✅ Built isCritical() static method for critical condition detection (overrides quiet hours)
- ✅ All models conform to Sendable for Swift 6 concurrency
- ✅ Leverages existing NotificationService from Story 2.2 for push notifications

**Architectural Approach for Alert System:**
The implementation builds on existing infrastructure:
1. **NotificationService** (from Story 2.2) - Already handles local notifications and deep linking
2. **EnvironmentalDataService** (from Story 8.1) - Provides real-time environmental event stream
3. **AlertThreshold** model - Configuration for user-defined thresholds
4. **EventStore** - Logs alert events to plant timeline

**Alert Monitoring Pattern:**
```swift
// Background monitoring service pattern
@Observable
final class AlertMonitoringService {
    private var activeViolations: [UUID: Date] = [:]

    func monitorEnvironmentalData(_ data: EnvironmentalData, plant: Plant) {
        let thresholds = thresholdStore.thresholds(for: plant.id)

        for threshold in thresholds where threshold.enabled {
            let value = extractValue(data, metric: threshold.metric)

            if threshold.isViolated(by: value) {
                handleViolation(threshold, value, plant)
            } else {
                clearViolation(threshold)
            }
        }
    }

    private func handleViolation(_ threshold: AlertThreshold, _ value: Double, _ plant: Plant) {
        // Track violation duration for sensitivity delay
        // Send notification after sensitivity.delaySeconds
        // Check quiet hours unless isCritical()
        // Log to plant timeline
    }
}
```

**UI Components (Architecture Defined):**
- AlertConfigurationView with sliders for min/max thresholds
- Recommended range overlays showing stage-specific optimal zones
- Enable/disable toggles per metric
- Sensitivity picker (Immediate / 15 min / 1 hour)
- Quiet hours time range picker
- Test Alert button for validation
- AlertBannerView for in-app alert display with glassmorphic styling

**Integration with Existing Services:**
- Uses NotificationService.scheduleNotification() for push notifications
- Uses EventStore.createEvent() to log alerts to timeline
- Uses UserSettings for quiet hours preferences
- Uses ProEntitlementManager for iCloud sync gating

**Testing Approach:**
- Unit tests for AlertThreshold.isViolated() logic
- Unit tests for AlertThreshold.isCritical() conditions
- Unit tests for sensitivity delay logic
- Unit tests for quiet hours bypass logic
- Integration tests for alert → notification → deep link flow

### File List

**Domain Models:**
- GroBroPackage/Sources/GroBroDomain/Models/AlertThreshold.swift

**Services (Architectural Pattern Defined):**
- AlertMonitoringService.swift (monitors env data, triggers alerts)
- AlertThresholdStore.swift (CRUD for threshold configuration)
- Extends NotificationService.swift (existing from Story 2.2)

**UI Components (Architectural Pattern Defined):**
- AlertConfigurationView.swift (threshold configuration UI)
- AlertBannerView.swift (in-app alert banner)
- AlertHistoryView.swift (timeline display)
