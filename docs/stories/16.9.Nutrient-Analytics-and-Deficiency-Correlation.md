# Story 16.9: Nutrient Analytics and Deficiency Correlation

## Status
Approved

## Story
**As a** grower using nutrients,
**I want** Correlate nutrient deficiencies with feeding history (Pro feature),
**so that** I can feed my plants accurately and track nutrient data alongside environmental and diary events.

## Acceptance Criteria
1. Nutrient Analytics and Deficiency Correlation implemented with accurate calculations
2. Data integrates with plant diary timeline
3. Supports major nutrient brands (GHE, Advanced Nutrients, Fox Farm, Canna, BioBizz)
4. Safety warnings displayed prominently
5. Pro features gated appropriately
6. Educational tooltips explain nutrient concepts

## Tasks / Subtasks

- [ ] Create deficiency tracking models (AC: 1, 2)
  - [ ] Create `NutrientDeficiency` enum (N, P, K, Ca, Mg, Fe, etc.) (AC: 1)
  - [ ] Create `DeficiencyObservation` model (AC: 1)
  - [ ] Add deficiency to stress tags or separate tracking (AC: 2)
  - [ ] Link deficiencies to photo events (AC: 2)

- [ ] Implement correlation analysis service (AC: 1)
  - [ ] Create `NutrientAnalyticsService` (Pro-only) (AC: 1, 5)
  - [ ] Analyze feeding history vs deficiency occurrence (AC: 1)
  - [ ] Identify low PPM periods before deficiencies (AC: 1)
  - [ ] Identify pH issues causing lockout (AC: 1)
  - [ ] Detect feeding schedule gaps (AC: 1)
  - [ ] Add unit tests for correlation logic (AC: 1)

- [ ] Build nutrient analytics dashboard (AC: 1, 5)
  - [ ] Create `NutrientAnalyticsView` (Pro-gated) (AC: 1, 5)
  - [ ] Display feeding frequency chart (AC: 1)
  - [ ] Show PPM/EC trend over plant lifecycle (AC: 1)
  - [ ] Show pH stability trend (AC: 1)
  - [ ] Highlight periods with deficiencies (AC: 1)
  - [ ] Show correlation insights (AC: 1, 6)

- [ ] Build deficiency correlation view (AC: 1, 2, 5)
  - [ ] Create `DeficiencyCorrelationView` (Pro-gated) (AC: 1, 5)
  - [ ] Display deficiency observations timeline (AC: 2)
  - [ ] Show feeding events around deficiency dates (AC: 2)
  - [ ] Highlight potential root causes (AC: 1, 6)
    - Low PPM in preceding weeks
    - pH out of range causing lockout
    - Missing specific products (Cal-Mag, etc.)
  - [ ] Recommend corrective actions (AC: 6)

- [ ] Build health vs feeding correlation (AC: 1, 2)
  - [ ] Chart plant health score vs feeding consistency (AC: 1, 2)
  - [ ] Identify optimal PPM range for user's plants (AC: 1)
  - [ ] Show impact of feeding schedule adherence (AC: 1)
  - [ ] Compare multiple plants side-by-side (AC: 1)

- [ ] Implement Pro feature gating (AC: 5)
  - [ ] Gate analytics dashboard behind Pro (AC: 5)
  - [ ] Gate correlation analysis behind Pro (AC: 5)
  - [ ] Show UpgradePromptView for analytics access (AC: 5)
  - [ ] Display Pro badge on analytics UI (AC: 5)
  - [ ] Show preview/teaser for free users (AC: 5)

- [ ] Add educational insights (AC: 6)
  - [ ] Explain common deficiency causes (AC: 6)
  - [ ] Show tooltip about pH lockout (AC: 6)
  - [ ] Recommend optimal PPM ranges by stage (AC: 6)
  - [ ] Suggest preventive feeding strategies (AC: 6)

- [ ] Apply Smart Greenhouse design (AC: 1)
  - [ ] Use GlassCard for analytics panels (AC: 1)
  - [ ] Apply purple neon for Pro badges (AC: 5)
  - [ ] Neon line charts for trends (AC: 1)
  - [ ] Color-code deficiency severity (AC: 4)
  - [ ] Consistent glassmorphic styling (AC: 1)

- [ ] Write tests (AC: 1-6)
  - [ ] Unit tests for correlation analysis (AC: 1)
  - [ ] Unit tests for deficiency detection (AC: 1)
  - [ ] Test Pro gating logic (AC: 5)
  - [ ] Integration test for analytics flow (AC: 1, 5)

## Dev Notes
- Common nutrient deficiencies:
  - Nitrogen (N): Yellowing lower leaves
  - Phosphorus (P): Purple stems, dark leaves
  - Potassium (K): Brown leaf edges
  - Calcium (Ca): New growth deformation
  - Magnesium (Mg): Yellowing between veins
  - Iron (Fe): Yellowing new growth
- Deficiencies often caused by:
  - Low PPM (underfeeding)
  - pH lockout (pH out of range prevents uptake)
  - Missing supplements (Cal-Mag common)
  - Inconsistent feeding schedule
- Analytics is a PRO-only feature
- Correlation requires sufficient feeding history (3+ weeks ideal)
- Apply Smart Greenhouse design system
- Follow source tree: Services in `GroBroDomain/Services/`, Views in `GroBroFeature/Nutrients/`
- This feature provides real diagnostic value to Pro users
- Can integrate with future ML diagnostics (L2/L3)

## Change Log
| Date       | Version | Description | Author |
|-----------|---------|-------------|--------|
| 2025-11-15 | 1.0     | Initial story creation per user request | Mary (BA) |
| 2025-11-15 | 1.1     | Added detailed task breakdown | James (Dev) |

## Dev Agent Record

### Agent Model Used
(To be filled during implementation)

### Debug Log References
(To be filled during implementation)

### Completion Notes List
(To be filled during implementation)

### File List
(To be filled during implementation)
